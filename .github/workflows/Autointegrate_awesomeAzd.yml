name: Awesome-azd Integration PR
permissions:
  actions: write
  contents: write
on:
  workflow_dispatch:

jobs:
    integrate_pr:
      runs-on: ubuntu-latest
      environment: "AzD Integration"

      steps:
        - name: Checkout respository
          uses: actions/checkout@v2
          with:
            ref: dev
          
        - name: Fetch workloads from azd and exec docs scenarios
          run: |
            curl -o ${{ github.workspace }}/templates.json https://raw.githubusercontent.com/Azure/awesome-azd/main/website/static/templates.json
            curl -o ${{ github.workspace }}/exec_metadata.json https://raw.githubusercontent.com/MicrosoftDocs/executable-docs/main/scenarios/metadata.json

        - name: Updating Workloads
          run: |
            echo "Running script"
            python ${{ github.workspace }}/scripts/add_workloads/add_azd.py --root ${{ github.workspace }} --input_file ${{ github.workspace }}/templates.json
            python ${{ github.workspace }}/scripts/add_workloads/add_exec_docs.py --root ${{ github.workspace }} --input_file ${{ github.workspace }}/exec_metadata.json
            rm ${{ github.workspace }}/templates.json
            rm ${{ github.workspace }}/exec_metadata.json

        - name: Generating Fields
          run: |
            echo "Generating New Fields"
            python ${{ github.workspace }}/scripts/generate_fields/generate_fields --root ${{ github.workspace }}

        - name: Configure Git
          run: |
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
        - name: Commit changes
          uses: stefanzweifel/git-auto-commit-action@v4
          with:
            commit_message: "Automated update of workloads.json"
            file_pattern: workloads/workloads.json

        - name: Create Pull Request
          uses: peter-evans/create-pull-request@v3
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
            branch: auto-update
            base: github/update-workload-fields
            title: 'Automated PR: Update workloads.json'
            body: 'This PR is created automatically to update workloads.json with the latest changes.'